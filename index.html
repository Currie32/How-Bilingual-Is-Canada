<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="//d3js.org/d3.v4.min.js"></script>
    <style>

    	#title {
    		text-align: center;
    		font-size: 24px;
    		padding: 0px;
    		margin: -10px 0px 5px;
    	}

    	#intro {
    		text-align: center;
    		font-style: italic;
    		font-family: times;
    		font-size: 18px;
    		color: #444;
    	}

    	#disclaimer {
    		top: 0px;
    		font-size: 12px;
    		text-align: right;
    		margin: -5px 0px 0px;
    		padding: 0px;
    		font-style: italic;
    	}

    	ul {
    		position: absolute;
	        text-align: center;
	        width: 135px;
	        top: 70px;
	        left: -10px;
      	}

      	li {
	        background-color: #89D582;
	        border: 1px solid #777;
	        padding: 3px 0px;
	        margin: 2px;
	        list-style-type: none;
	        border-radius: 5px;
	        font-size: 16px;
      	}

      	li:hover {
      		background-color: #63B15C;
      	}

      	li.selected {
      		background-color: #32762C;
      	}

      	.cities {
      		fill: red;
      		opacity: 0.7;
      	}

      	.tip {
      		background-color: #E8E8E8;
      		border: 1px solid black;
      		padding: 5px;
      		border-radius: 10px;
      		opacity: 0.2;
      		top: 200px;
      		left: 250px;
      		position: absolute;
      	}

      	.tip p, .tooltip p {
      		margin: 5px 5px;
      	}

      	.tooltip {
      		background-color: #BBECEC;
      		position: absolute;
      		top: 40px;
      		right: 20px;
      		padding: 5px 10px;
      		margin: 0px;
      		border-radius: 10px;
      		border: 1px solid black;
      	}

      	#province_tag {
      		color: #777;
      		text-align: center;
      		font-size: 18px;
      		font-weight: 600;
      	}

      	body {
      		background-color: #E8E8E8;
      	}

    </style>

    <body>

    	<div id="disclaimer">**Population data from the 2011 Canadian Census.</div>

    	<div id="title">How Bilingual Is Canada?</div>

    	<div id="intro">
    		Although many believe that Canadians typically speak two languages,<br>
    		use these visualizations too see that speaking French is much less common than 
    		you may have expected.
    	</div>

		<div id="menu">
			<ul id="speakers_menu"></ul>
		</div>

	</body>

    <script type="text/javascript"> 

    	var geo_data = "canada.geojson";
    	var city_data = "canada_info2.csv";
    	var speaker = "Population";
    	var margin = 0,
	        width = 1270 - margin,
	        height = 570 - margin,
	        scale0 = (width - 1)/ 3 / Math.PI;

      	function draw(data) {
	        "use strict";

	        var svg = d3.select("body")
	            .append("svg")
	            .attr("width", width + margin)
	            .attr("height", height + margin)
	            .append('g')
	            .attr('class', 'map');

	        svg.append("rect")
	        	.attr("class", "bg")
    			.attr("width", "100%")
			    .attr("height", "100%")
			    .attr("fill", "#E8E8E8")
			    .attr("stroke", "black")
			    .attr("stroke-width", "0px");

	        var languages = ['Only English',
	        				 'Only French',
	        				 'Bilingual',
	        				 'Neither',
	        				 'Population'
	        				 ];

	        var projection = d3.geoConicEquidistant()
               .scale(750)
               .translate( [width / 4.8, height * 1.66])
               .rotate([105,0,0]);

	        var path = d3.geoPath().projection(projection);

	        function zoom() {
  				map.attr("transform", "translate(" + 
  					d3.translateBy + ")scale(" + 
  					d3.scale + ")");
			}

	        var map = svg.selectAll('path')
	            .data(data.features)
	            .enter()
	            .append('path')
	            .attr('d', path)
	            .style('fill', 'lightblue')
	            .style('stroke', 'black')
	            .style('stroke-width', 0.5)
	            .style('opacity', 0.7)
	            .call(d3.zoom().on("zoom", function () {
        			svg.attr("transform", d3.event.transform)
				}))

	        var radius = d3.scaleSqrt()
				.domain([0, 1000000])
				.range([0,4]);

			var tip = d3.select("body")
				.append("div")
			    .attr("class", "tip")
			    .style("opacity", 0);

			d3.select('#speakers_menu')
				.selectAll('li')
				.data(languages)
				.enter()
				.append('li')
				.text(function(d) {return d;})
				.style('cursor', 'pointer')
				.classed('selected', function(d) {
					return d === speaker;
				})
				.on('click', function(d) {
					speaker = d;
					d3.csv(city_data, update);
					updateMenus();
				});
            
            d3.csv("canada_info2.csv", function(data) {
	            svg.append('g')
	            	.attr("class", "cities")
	            	.selectAll("circle")
		           	.data(data)
		           	.enter()
		           	.append("circle")
		           	.attr("cx", function(d) {
		                return projection([+d.longitude, +d.latitude])[0];
		           	})
		           	.attr("cy", function(d) {
		                return projection([+d.longitude, +d.latitude])[1];
		           	})
		           	.attr("r", function(d) {
                    	return radius(d['Population']);
               		})
               		.style('cursor', 'pointer')
					.on('mouseover', function(d) {
						tip.transition()
			         		.style("opacity", .9)
						tip.html(function(data) {
							return 	"<p><strong>City:</strong> <span style='color:red'>" + 
									(d['city']) + "</span></p>" +
									"<p><strong>Population:</strong> <span style='color:blue'>" + 
									(d['Population']) + "</span></p>" +
									"<p><strong>English Speakers:</strong> <span style='color:blue'>" +
									(d['Only English']) + "</span></p>" +
									"<p><strong>French Speakers:</strong> <span style='color:blue'>" + 
									(d['Only French']) + "</span></p>" +
									"<p><strong>Bilingual Speakers:</strong> <span style='color:blue'>" + 
									(d['Bilingual']) + "</span></p>" +
									"<p><strong>Neither:</strong> <span style='color:blue'>" + 
									(d['Neither']) + "</span></p>";
						});
					})
					.on("mouseout", function(d) {
			   			tip.transition()
			         		.style("opacity", 0)
			         	})
					.call(d3.zoom().on("zoom", function () {
        				svg.attr("transform", d3.event.transform)
					}));
			});

			function update(data) {

				d3.selectAll("circle")
					.remove()

				svg.append('g')
					.attr("class", "cities")
					.selectAll("circle")
					.data(data)
					.enter()
					.append("circle")
					.attr("cx", function(d) {
	                	return projection([+d.longitude, +d.latitude])[0];
	           		})
	           		.attr("cy", function(d) {
	                	return projection([+d.longitude, +d.latitude])[1];
	           		})
	           		.attr("r", function(d) {
                		return radius(d[speaker]);
           			})
           			.style('cursor', 'pointer')
					.on('mouseover', function(d) {
						tip.transition()
			         		.style("opacity", .9)
						tip.html(function(data) {
							return 	"<p><strong>City:</strong> <span style='color:red'>" + 
									(d['city']) + "</span></p>" +
									"<p><strong>English Speakers:</strong> <span style='color:blue'>" +
									(d['Only English']) + "</span></p>" +
									"<p><strong>French Speakers:</strong> <span style='color:blue'>" + 
									(d['Only French']) + "</span></p>" +
									"<p><strong>Bilingual Speakers:</strong> <span style='color:blue'>" + 
									(d['Bilingual']) + "</span></p>" +
									"<p><strong>Neither:</strong> <span style='color:blue'>" + 
									(d['Neither']) + "</span></p>";
						});
					})
					.on("mouseout", function(d) {
			   			tip.transition()
			         		.style("opacity", 0)
			         	})
					.call(d3.zoom().on("zoom", function () {
        				svg.attr("transform", d3.event.transform)
					}));
		    };
		    	
			function updateMenus() {
				d3.select('#speakers_menu')
				.selectAll('li')
				.classed('selected', function(d) {
					return d === speaker;
				});
			};



			//bottom function



			var x = d3.scaleBand()
			    .rangeRound([750, width - 10])
			    .padding(0.1);

			var y = d3.scaleLinear()
			    .rangeRound([440, 140]);

			var z = d3.scaleOrdinal()
			    .range(["#353261", "#3D84A8", "#8ECBCB", "#5EB69A"]);

			var stack = d3.stack();

			var percent_format = d3.format(".2%");

			var tooltip = d3.select("body")
				.append("div")
			    .attr("class", "tooltip")
			    .style("opacity", 0);

			d3.csv("province_info.csv", type, function(error, data) {
			  if (error) throw error;

			  data.sort(function(a, b) { return b.total - a.total; });

			  x.domain(data.map(function(d) { return d.province; }));
			  y.domain([0, 1]);
			  z.domain(data.columns.slice(1));

			  svg.selectAll(".serie")
			    .data(stack.keys(data.columns.slice(1))(data))
			    .enter().append("g")
			      .attr("class", "serie")
			      .attr("fill", function(d) { return z(d.key); })
			    .selectAll("rect")
			    .data(function(d) { return d; })
			    .enter().append("rect")
			      	.attr("x", function(d) { return x(d.data.province); })
			      	.attr("y", function(d) { return y(d[1]); })
			      	.attr("height", function(d) { return y(d[0]) - y(d[1]); })
			      	.attr("width", x.bandwidth())
			      	.on("mouseover", function(d) {
			       		tooltip.transition()
			         		.style("opacity", 1);
			       		tooltip.html(function(data) {
							return "<p id = province_tag><span>" + 
									(d.data['province']) + "</span></p>" +
									"<p><strong>Only English:</strong> <span style='color:blue'>" + 
									percent_format((d.data['Only English'])) + "</span></p>" +
									"<p><strong>Only French:</strong> <span style='color:blue'>" + 
									percent_format((d.data['Only French'])) + "</span></p>" +
									"<p><strong>Bilingual:</strong> <span style='color:blue'>" + 
									percent_format((d.data['Bilingual'])) + "</span></p>" +
									"<p><strong>Neither:</strong> <span style='color:blue'>" + 
									percent_format((d.data['Neither'])) + "</span></p>";
						});
			   		})
			   		.on("mouseout", function(d) {
			   			tooltip.transition()
			         		.style("opacity", 0);
			   		})

			  svg.append("g")
			      	.attr("class", "axis axis--x")
			      	.attr("transform", "translate(0,450)")
			      	.call(d3.axisBottom(x))
			      	.selectAll('text')
			      		.attr("transform", "rotate(55) translate(23,0)");

			  svg.append("g")
				    .attr("class", "axis axis--y")
				    .call(d3.axisLeft(y).ticks(5, "p"))
				    .attr("transform", "translate(740,0)")
			    	.append("text")
			      		.attr("x", 5)
				      	.attr("y", y(y.ticks(5).pop()))
				      	.attr("dy", "0.35em")
				      	.attr("text-anchor", "start")
				      	.attr("fill", "#000")
				      	.attr("transform", "translate(-185,320) rotate(-90)")
				      	.attr("font-size", "14px")
				      	.text("Population")
				      	.style("font-family", "times");

			  var legend = svg.selectAll(".legend")
			    .data(data.columns.slice(1).reverse())
			    .enter()
			    .append("g")
			    .attr("class", "legend")
			    .attr("transform", function(d, i) { return "translate("+(i * (-100) - 50) +",110)"; })
			    .style("font", "11px sans-serif");

			  legend.append("rect")
			      .attr("x", width - 18)
			      .attr("width", 18)
			      .attr("height", 18)
			      .attr("fill", z)
			      .style("stroke", "black");

			  legend.append("text")
			      .attr("x", width - 24)
			      .attr("y", 9)
			      .attr("dy", ".35em")
			      .attr("text-anchor", "end")
			      .text(function(d) { return d; });
			});
			var t = 0
			function type(d, i, columns) {
			  for (i = 1, t = 0; i < columns.length; ++i) t += d[columns[i]] = +d[columns[i]];
			  d.total = t;
			  return d;
			};

      	};

		d3.json(geo_data, draw);
			

      </script>

  </head>
</html>
